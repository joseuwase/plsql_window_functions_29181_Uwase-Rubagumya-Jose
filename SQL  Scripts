
Server [localhost]:
Database [postgres]:
Port [5432]:
Username [postgres]:
Password for user postgres:

psql (18.0)
WARNING: Console code page (850) differs from Windows code page (1252)
         8-bit characters might not work correctly. See psql reference
         page "Notes for Windows users" for details.
Type "help" for help.

postgres=# CREATE DATABASE hospital_db;
CREATE DATABASE
postgres=# CREATE TABLE departments (
postgres(#     department_id INT AUTO_INCREMENT PRIMARY KEY,
postgres(#     department_name VARCHAR(100) NOT NULL,
postgres(#     location VARCHAR(100)
postgres(# );
ERROR:  syntax error at or near "AUTO_INCREMENT"
LINE 2:     department_id INT AUTO_INCREMENT PRIMARY KEY,
                              ^
postgres=# CREATE TABLE departments (
postgres(#     department_id SERIAL PRIMARY KEY,
postgres(#     department_name VARCHAR(100) NOT NULL,
postgres(#     location VARCHAR(100)
postgres(# );
CREATE TABLE
postgres=# CREATE TABLE patients (
postgres(#     patient_id SERIAL PRIMARY KEY,
postgres(#     full_name VARCHAR(100) NOT NULL,
postgres(#     gender VARCHAR(10),
postgres(#     age INT,
postgres(#     department_id INT,
postgres(#     phone VARCHAR(15),
postgres(#     CONSTRAINT fk_department
postgres(#         FOREIGN KEY (department_id)
postgres(#         REFERENCES departments(department_id)
postgres(# );
CREATE TABLE
postgres=# CREATE TABLE billing (
postgres(#     bill_id SERIAL PRIMARY KEY,
postgres(#     patient_id INT,
postgres(#     bill_date DATE,
postgres(#     amount NUMERIC(10,2),
postgres(#     payment_status VARCHAR(20),
postgres(#     CONSTRAINT fk_patient
postgres(#         FOREIGN KEY (patient_id)
postgres(#         REFERENCES patients(patient_id)
postgres(# );
CREATE TABLE
postgres=# \d departments;
                                              Table "public.departments"
     Column      |          Type          | Collation | Nullable |                      Default
-----------------+------------------------+-----------+----------+----------------------------------------------------
 department_id   | integer                |           | not null | nextval('departments_department_id_seq'::regclass)
 department_name | character varying(100) |           | not null |
 location        | character varying(100) |           |          |
Indexes:
    "departments_pkey" PRIMARY KEY, btree (department_id)
Referenced by:
    TABLE "patients" CONSTRAINT "fk_department" FOREIGN KEY (department_id) REFERENCES departments(department_id)


postgres=# \d patients;
                                           Table "public.patients"
    Column     |          Type          | Collation | Nullable |                   Default
---------------+------------------------+-----------+----------+----------------------------------------------
 patient_id    | integer                |           | not null | nextval('patients_patient_id_seq'::regclass)
 full_name     | character varying(100) |           | not null |
 gender        | character varying(10)  |           |          |
 age           | integer                |           |          |
 department_id | integer                |           |          |
 phone         | character varying(15)  |           |          |
Indexes:
    "patients_pkey" PRIMARY KEY, btree (patient_id)
Foreign-key constraints:
    "fk_department" FOREIGN KEY (department_id) REFERENCES departments(department_id)
Referenced by:
    TABLE "billing" CONSTRAINT "fk_patient" FOREIGN KEY (patient_id) REFERENCES patients(patient_id)


postgres=# \d billing;
                                          Table "public.billing"
     Column     |         Type          | Collation | Nullable |                 Default
----------------+-----------------------+-----------+----------+------------------------------------------
 bill_id        | integer               |           | not null | nextval('billing_bill_id_seq'::regclass)
 patient_id     | integer               |           |          |
 bill_date      | date                  |           |          |
 amount         | numeric(10,2)         |           |          |
 payment_status | character varying(20) |           |          |
Indexes:
    "billing_pkey" PRIMARY KEY, btree (bill_id)
Foreign-key constraints:
    "fk_patient" FOREIGN KEY (patient_id) REFERENCES patients(patient_id)


postgres=# -- Retrieve patients with their billing details
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     b.amount,
postgres-#     b.bill_date
postgres-# FROM patients p
postgres-# INNER JOIN billing b
postgres-#     ON p.patient_id = b.patient_id;
 full_name | amount | bill_date
-----------+--------+-----------
(0 rows)


postgres=# -- Retrieve patients who have never been billed
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     p.admission_date,
postgres-#     b.amount
postgres-# FROM patients p
postgres-# LEFT JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# WHERE b.bill_id IS NULL;
ERROR:  column p.admission_date does not exist
LINE 3:     p.admission_date,
            ^
postgres=# -- Retrieve patients who have never been billed
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     b.amount
postgres-# FROM patients p
postgres-# LEFT JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# WHERE b.bill_id IS NULL;
 full_name | amount
-----------+--------
(0 rows)


postgres=# -- Detect billing records that are not linked to any patient
postgres=# SELECT
postgres-#     b.bill_id,
postgres-#     b.amount,
postgres-#     p.full_name
postgres-# FROM patients p
postgres-# RIGHT JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# WHERE p.patient_id IS NULL;
 bill_id | amount | full_name
---------+--------+-----------
(0 rows)


postgres=# -- Equivalent using LEFT JOIN (preferred by some instructors)
postgres=# SELECT
postgres-#     b.bill_id,
postgres-#     b.amount,
postgres-#     p.full_name
postgres-# FROM billing b
postgres-# LEFT JOIN patients p
postgres-#     ON p.patient_id = b.patient_id
postgres-# WHERE p.patient_id IS NULL;
 bill_id | amount | full_name
---------+--------+-----------
(0 rows)


postgres=# -- Compare patients and departments including unmatched records
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     d.department_name
postgres-# FROM patients p
postgres-# FULL OUTER JOIN departments d
postgres-#     ON p.department_id = d.department_id;
 full_name | department_name
-----------+-----------------
(0 rows)


postgres=# -- Compare departments located in the same location
postgres=# SELECT
postgres-#     a.department_name AS Department_A,
postgres-#     b.department_name AS Department_B,
postgres-#     a.location
postgres-# FROM departments a
postgres-# JOIN departments b
postgres-#     ON a.location = b.location
postgres-#    AND a.department_id <> b.department_id;
 department_a | department_b | location
--------------+--------------+----------
(0 rows)


postgres=# -- Insert sample departments
postgres=# INSERT INTO departments (department_name, location)
postgres-# VALUES
postgres-# ('Emergency', 'Block A'),
postgres-# ('Pediatrics', 'Block B'),
postgres-# ('Laboratory', 'Block C'),
postgres-# ('Cardiology', 'Block D'),
postgres-# ('Radiology', 'Block A');
INSERT 0 5
postgres=# -- Insert sample patients
postgres=# INSERT INTO patients (full_name, gender, age, department_id, phone)
postgres-# VALUES
postgres-# ('Uwase Josee', 'Female', 20, 2, '0781234567'),
postgres-# ('John Doe', 'Male', 30, 1, '0799876543'),
postgres-# ('Alice Mukamana', 'Female', 25, 3, '0787654321'),
postgres-# ('Bob Manzi', 'Male', 40, 1, '0781112233'),
postgres-# ('Claire Uwimana', 'Female', 35, NULL, '0791122334'); -- Patient without department
INSERT 0 5
postgres=# -- Insert sample billing records
postgres=# INSERT INTO billing (patient_id, bill_date, amount, payment_status)
postgres-# VALUES
postgres-# (1, '2026-02-01', 50000, 'Paid'),
postgres-# (2, '2026-02-03', 75000, 'Pending'),
postgres-# (3, '2026-02-05', 60000, 'Paid'),
postgres-# (4, '2026-02-06', 80000, 'Pending'),
postgres-# (999, '2026-02-07', 90000, 'Paid'); -- Invalid patient_id to test RIGHT JOIN
ERROR:  insert or update on table "billing" violates foreign key constraint "fk_patient"
DETAIL:  Key (patient_id)=(999) is not present in table "patients".
postgres=# select * from patients
postgres-# select * from patients;
ERROR:  syntax error at or near "select"
LINE 2: select * from patients;
        ^
postgres=# select * from patients;
 patient_id |   full_name    | gender | age | department_id |   phone
------------+----------------+--------+-----+---------------+------------
          1 | Uwase Josee    | Female |  20 |             2 | 0781234567
          2 | John Doe       | Male   |  30 |             1 | 0799876543
          3 | Alice Mukamana | Female |  25 |             3 | 0787654321
          4 | Bob Manzi      | Male   |  40 |             1 | 0781112233
          5 | Claire Uwimana | Female |  35 |               | 0791122334
(5 rows)


postgres=# select * from billing;
 bill_id | patient_id | bill_date | amount | payment_status
---------+------------+-----------+--------+----------------
(0 rows)


postgres=# -- Insert billing records for existing patients
postgres=# INSERT INTO billing (patient_id, bill_date, amount, payment_status)
postgres-# VALUES
postgres-# (1, '2026-02-01', 50000, 'Paid'),      -- Uwase Josee
postgres-# (2, '2026-02-03', 75000, 'Pending'),   -- John Doe
postgres-# (3, '2026-02-05', 60000, 'Paid'),      -- Alice Mukamana
postgres-# (4, '2026-02-06', 80000, 'Pending');   -- Bob Manzi
INSERT 0 4
postgres=# -- Claire Uwimana (patient_id=5) has NO billing record to test LEFT JOIN
postgres=# -- Retrieve patients with their billing details
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     b.amount,
postgres-#     b.bill_date
postgres-# FROM patients p
postgres-# INNER JOIN billing b
postgres-#     ON p.patient_id = b.patient_id;
   full_name    |  amount  | bill_date
----------------+----------+------------
 Uwase Josee    | 50000.00 | 2026-02-01
 John Doe       | 75000.00 | 2026-02-03
 Alice Mukamana | 60000.00 | 2026-02-05
 Bob Manzi      | 80000.00 | 2026-02-06
(4 rows)


postgres=# -- Retrieve patients who have never been billed
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     p.admission_date,
postgres-#     b.amount
postgres-# FROM patients p
postgres-# LEFT JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# WHERE b.bill_id IS NULL;
ERROR:  column p.admission_date does not exist
LINE 3:     p.admission_date,
            ^
postgres=# -- Retrieve patients who have never been billed
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     b.amount
postgres-# FROM patients p
postgres-# LEFT JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# WHERE b.bill_id IS NULL;
   full_name    | amount
----------------+--------
 Claire Uwimana |
(1 row)


postgres=# -- Detect billing records that are not linked to any patient
postgres=# SELECT
postgres-#     b.bill_id,
postgres-#     b.amount,
postgres-#     p.full_name
postgres-# FROM patients p
postgres-# RIGHT JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# WHERE p.patient_id IS NULL;
 bill_id | amount | full_name
---------+--------+-----------
(0 rows)


postgres=# -- Compare patients and departments including unmatched records
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     d.department_name
postgres-# FROM patients p
postgres-# FULL OUTER JOIN departments d
postgres-#     ON p.department_id = d.department_id;
   full_name    | department_name
----------------+-----------------
 Uwase Josee    | Pediatrics
 John Doe       | Emergency
 Alice Mukamana | Laboratory
 Bob Manzi      | Emergency
 Claire Uwimana |
                | Radiology
                | Cardiology
(7 rows)


postgres=# -- Compare departments located in the same location
postgres=# SELECT
postgres-#     a.department_name AS Department_A,
postgres-#     b.department_name AS Department_B,
postgres-#     a.location
postgres-# FROM departments a
postgres-# JOIN departments b
postgres-#     ON a.location = b.location
postgres-#    AND a.department_id <> b.department_id;
 department_a | department_b | location
--------------+--------------+----------
 Emergency    | Radiology    | Block A
 Radiology    | Emergency    | Block A
(2 rows)


postgres=# -- Ranking patients based on total billed amount
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     SUM(b.amount) AS total_amount,
postgres-#     ROW_NUMBER() OVER (ORDER BY SUM(b.amount) DESC) AS row_num,
postgres-#     RANK() OVER (ORDER BY SUM(b.amount) DESC) AS rank_num,
postgres-#     DENSE_RANK() OVER (ORDER BY SUM(b.amount) DESC) AS dense_rank_num,
postgres-#     PERCENT_RANK() OVER (ORDER BY SUM(b.amount) DESC) AS percent_rank
postgres-# FROM patients p
postgres-# JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# GROUP BY p.full_name
postgres-# ORDER BY total_amount DESC;
   full_name    | total_amount | row_num | rank_num | dense_rank_num |    percent_rank
----------------+--------------+---------+----------+----------------+--------------------
 Bob Manzi      |     80000.00 |       1 |        1 |              1 |                  0
 John Doe       |     75000.00 |       2 |        2 |              2 | 0.3333333333333333
 Alice Mukamana |     60000.00 |       3 |        3 |              3 | 0.6666666666666666
 Uwase Josee    |     50000.00 |       4 |        4 |              4 |                  1
(4 rows)


postgres=# -- Calculate running total and average of billing amounts by patient
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     b.bill_date,
postgres-#     b.amount,
postgres-#     SUM(b.amount) OVER (PARTITION BY p.full_name ORDER BY b.bill_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total,
postgres-#     AVG(b.amount) OVER (PARTITION BY p.full_name ORDER BY b.bill_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_avg,
postgres-#     MIN(b.amount) OVER (PARTITION BY p.full_name ORDER BY b.bill_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_min,
postgres-#     MAX(b.amount) OVER (PARTITION BY p.full_name ORDER BY b.bill_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_max
postgres-# FROM patients p
postgres-# JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# ORDER BY p.full_name, b.bill_date;
   full_name    | bill_date  |  amount  | running_total |    running_avg     | running_min | running_max
----------------+------------+----------+---------------+--------------------+-------------+-------------
 Alice Mukamana | 2026-02-05 | 60000.00 |      60000.00 | 60000.000000000000 |    60000.00 |    60000.00
 Bob Manzi      | 2026-02-06 | 80000.00 |      80000.00 | 80000.000000000000 |    80000.00 |    80000.00
 John Doe       | 2026-02-03 | 75000.00 |      75000.00 | 75000.000000000000 |    75000.00 |    75000.00
 Uwase Josee    | 2026-02-01 | 50000.00 |      50000.00 | 50000.000000000000 |    50000.00 |    50000.00
(4 rows)


postgres=# -- Show previous and next billing amount for comparison
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     b.bill_date,
postgres-#     b.amount,
postgres-#     LAG(b.amount) OVER (PARTITION BY p.full_name ORDER BY b.bill_date) AS previous_bill,
postgres-#     LEAD(b.amount) OVER (PARTITION BY p.full_name ORDER BY b.bill_date) AS next_bill
postgres-# FROM patients p
postgres-# JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# ORDER BY p.full_name, b.bill_date;
   full_name    | bill_date  |  amount  | previous_bill | next_bill
----------------+------------+----------+---------------+-----------
 Alice Mukamana | 2026-02-05 | 60000.00 |               |
 Bob Manzi      | 2026-02-06 | 80000.00 |               |
 John Doe       | 2026-02-03 | 75000.00 |               |
 Uwase Josee    | 2026-02-01 | 50000.00 |               |
(4 rows)


postgres=# -- Segment patients into 4 groups based on total billed amount
postgres=# SELECT
postgres-#     p.full_name,
postgres-#     SUM(b.amount) AS total_amount,
postgres-#     NTILE(4) OVER (ORDER BY SUM(b.amount) DESC) AS quartile,
postgres-#     CUME_DIST() OVER (ORDER BY SUM(b.amount) DESC) AS cumulative_distribution
postgres-# FROM patients p
postgres-# JOIN billing b
postgres-#     ON p.patient_id = b.patient_id
postgres-# GROUP BY p.full_name
postgres-# ORDER BY total_amount DESC;
   full_name    | total_amount | quartile | cumulative_distribution
----------------+--------------+----------+-------------------------
 Bob Manzi      |     80000.00 |        1 |                    0.25
 John Doe       |     75000.00 |        2 |                     0.5
 Alice Mukamana |     60000.00 |        3 |                    0.75
 Uwase Josee    |     50000.00 |        4 |                       1
(4 rows)


postgres=#
